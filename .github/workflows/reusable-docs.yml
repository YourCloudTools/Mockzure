name: Publish Documentation

on:
  workflow_call:
    inputs:
      docs-path:
        type: string
        required: false
        default: docs
      coverage-artifact:
        type: string
        required: false
        default: coverage-report
      coverage-run-id:
        type: string
        required: false
        default: ''
      rpm-artifact:
        type: string
        required: false
        default: ''
      rpm-run-id:
        type: string
        required: false
        default: ''
      include-rpm:
        type: boolean
        required: false
        default: false
      commit-message:
        type: string
        required: false
        default: Publish documentation site

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download coverage artifact (external run)
        if: ${{ inputs.coverage-artifact != '' && inputs.coverage-run-id != '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.coverage-artifact }}
          run-id: ${{ inputs.coverage-run-id }}
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: coverage

      - name: Download coverage artifact (current run)
        if: ${{ inputs.coverage-artifact != '' && inputs.coverage-run-id == '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.coverage-artifact }}
          path: coverage

      - name: Download RPM artifact (external run)
        if: ${{ inputs.include-rpm && inputs.rpm-artifact != '' && inputs.rpm-run-id != '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.rpm-artifact }}
          run-id: ${{ inputs.rpm-run-id }}
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: rpm-artifacts

      - name: Download RPM artifact (current run)
        if: ${{ inputs.include-rpm && inputs.rpm-artifact != '' && inputs.rpm-run-id == '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.rpm-artifact }}
          path: rpm-artifacts

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Prepare documentation content
        run: |
          DOCS_PATH="${{ inputs.docs-path }}"
          mkdir -p site-src

          if [ -d "$DOCS_PATH" ]; then
            rsync -a --delete "$DOCS_PATH/" site-src/
          else
            echo "Warning: documentation directory '$DOCS_PATH' not found"
          fi

          if [ -d "coverage" ] && [ -f "coverage/coverage.out" ]; then
            chmod +x bin/prepare-docs.sh
            ./bin/prepare-docs.sh --coverage-file coverage/coverage.out --docs-dir site-src
            if [ -d "docs" ]; then
              rsync -a docs/ site-src/
            fi
          fi

          if [ -d "rpm-artifacts" ]; then
            mkdir -p site-src/rpms
            rsync -a rpm-artifacts/ site-src/rpms/
          fi

      - name: Generate RPM repository metadata
        if: ${{ inputs.include-rpm && inputs.rpm-artifact != '' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y createrepo-c
          mkdir -p site-src/rpms
          if compgen -G "site-src/rpms/*.rpm" > /dev/null; then
            pushd site-src/rpms
            createrepo_c .
            LATEST_RPM=$(ls -t mockzure-*.rpm | head -n 1)
            if [ -n "$LATEST_RPM" ]; then
              ln -sf "$LATEST_RPM" mockzure-latest.rpm
            fi
            popd
          else
            echo "No RPM files to process."
          fi

      - name: Ensure index page
        run: |
          mkdir -p site-src
          if [ ! -f "site-src/index.html" ]; then
            git checkout origin/main -- scripts/create-gh-pages-index.sh || true
            if [ -f "scripts/create-gh-pages-index.sh" ]; then
              chmod +x scripts/create-gh-pages-index.sh
              ./scripts/create-gh-pages-index.sh site-src
            fi
          fi

      - name: Switch to gh-pages branch
        run: |
          git fetch origin gh-pages || true
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git checkout gh-pages
            git reset --hard origin/gh-pages
          else
            git checkout --orphan gh-pages
          fi

      - name: Publish documentation content
        run: |
          rm -rf *
          rsync -a site-src/ .

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "No documentation changes to publish."
          else
            git commit -m "${{ inputs.commit-message }}"
            git push origin gh-pages
          fi

