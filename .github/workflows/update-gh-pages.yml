name: Update GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  update-gh-pages:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch gh-pages branch
        run: |
          git fetch origin gh-pages:gh-pages || echo "gh-pages branch doesn't exist yet"

      - name: Checkout gh-pages branch
        run: |
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf . || true
          fi

      - name: Copy documentation and create index.html
        run: |
          # Copy all docs content
          if [ -d "../docs" ]; then
            cp -r ../docs/* .
            echo "Copied documentation files"
          fi
          
          # Ensure index.html exists in root
          if [ ! -f "index.html" ]; then
            if [ -f "docs/index.html" ]; then
              cp docs/index.html .
              echo "Copied docs/index.html to root"
            else
              echo "Creating fallback index.html..."
              cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mockzure - Mock Azure Service</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .section { margin: 30px 0; }
        .section h2 { color: #666; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .section a { color: #007acc; text-decoration: none; }
        .section a:hover { text-decoration: underline; }
        .nav { text-align: center; margin: 30px 0; }
        .nav a { display: inline-block; margin: 0 15px; padding: 10px 20px; background: #007acc; color: white; border-radius: 5px; }
        .nav a:hover { background: #005a9e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Mockzure</h1>
        <p style="text-align: center; font-size: 18px; color: #666;">
            Mock Azure Service - Development & Testing
        </p>
        
        <div class="nav">
            <a href="docs/">Documentation</a>
            <a href="rpms/">RPM Packages</a>
            <a href="docs/coverage.html">Coverage Report</a>
        </div>
        
        <div class="section">
            <h2>📦 RPM Repository</h2>
            <p>Download the latest Mockzure RPM packages from our repository:</p>
            <ul>
                <li><a href="rpms/">Browse RPM Packages</a></li>
                <li><a href="rpms/index.html">Installation Guide</a></li>
            </ul>
        </div>
        
        <div class="section">
            <h2>📚 Documentation</h2>
            <p>Comprehensive documentation for Mockzure:</p>
            <ul>
                <li><a href="docs/getting-started.html">Getting Started</a></li>
                <li><a href="docs/api-reference.html">API Reference</a></li>
                <li><a href="docs/architecture.html">Architecture</a></li>
                <li><a href="docs/compatibility.html">Azure API Compatibility</a></li>
            </ul>
        </div>
        
        <div class="section">
            <h2>🧪 Testing & Coverage</h2>
            <p>View our test coverage and quality metrics:</p>
            <ul>
                <li><a href="docs/coverage.html">Coverage Report</a></li>
                <li><a href="docs/coverage-summary.json">Coverage Summary</a></li>
            </ul>
        </div>
        
        <div class="section">
            <h2>🔗 Quick Links</h2>
            <ul>
                <li><a href="https://github.com/YourCloudTools/Mockzure">GitHub Repository</a></li>
                <li><a href="docs/CONFIGURATION.md">Configuration Guide</a></li>
                <li><a href="docs/CICD_GUIDE.md">CI/CD Guide</a></li>
            </ul>
        </div>
        
        <div style="text-align: center; margin-top: 40px; color: #999; font-size: 14px;">
            <p>Part of the <a href="https://github.com/YourCloudTools">YourCloudTools</a> project</p>
        </div>
    </div>
</body>
</html>
EOF
              echo "Created fallback index.html"
            fi
          fi
          
          # List final contents for debugging
          echo "Final directory contents:"
          ls -la

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push to gh-pages
        run: |
          git add .
          git status
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update GitHub Pages with latest documentation and index.html"
            git push origin gh-pages
          fi

      - name: Summary
        run: |
          echo "## GitHub Pages Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **GitHub Pages Updated Successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation files from \`docs/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "- \`index.html\` landing page" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🌐 **View at**: https://yourcloudtools.github.io/Mockzure/" >> $GITHUB_STEP_SUMMARY
